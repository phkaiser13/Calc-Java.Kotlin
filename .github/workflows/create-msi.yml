# .github/workflows/create-msi.yml
#
# 2025
# By Pedro Henrique Garcia.
# Github/gitlab: Phkaiser13

# Nome do workflow que aparecerá na aba "Actions" do GitHub.
name: Create MSI Installer

# Gatilho: executa este workflow a cada commit na branch 'main'.
on:
  push:
    branches: [ "main" ]

jobs:
  build-installer:
    # O trabalho será executado em uma máquina virtual Windows.
    runs-on: windows-latest

    steps:
      # 1. Baixa o código do seu repositório.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configura o ambiente Java (JDK 21).
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Executa a tarefa 'installDist' para compilar e agrupar a aplicação.
      - name: Build application distribution with Gradle
        run: ./gradlew.bat :ui:installDist

      # 4. (Passo de Depuração) Lista os arquivos na pasta de distribuição.
      # Isso ajuda a verificar se os caminhos e nomes de arquivos estão corretos antes de empacotar.
      - name: List files in distribution directory
        run: |
          echo "Listing contents of ui/build/install/ui..."
          ls -R ui/build/install/ui
        shell: bash

      # 5. Cria o instalador .msi usando a ferramenta 'jpackage'.
      # A correção está na linha '--input', que agora aponta para a subpasta 'lib'.
      - name: Create MSI Installer with jpackage
        run: |
          jpackage --type msi `
            --dest release `
            --name JavaCalc `
            --app-version 1.0.0 `
            --vendor "Pedro Henrique Garcia" `
            --input ui/build/install/ui/lib `
            --main-jar ui-1.0.0.jar `
            --main-class com.phg.javacalc.ui.MainApplication `
            --icon ui/src/main/resources/com/phg/javacalc/ui/icon.ico
        shell: powershell

      # 6. Faz o upload do instalador gerado como um "artefato".
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v3
        with:
          name: JavaCalc-Installer
          path: release/
